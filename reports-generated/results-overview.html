<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Results Overview - CL Test Grid</title>

    <style type="text/css">
      
        body {
          width: 100ex;
          margin-left: auto;
          margin-right: auto;
        }

        h1 a {
          text-decoration: none;
        }
        
        .test-table {
          border-spacing: 0px;
        }

        .test-table td {
          font-weight: bold;
          border-color: black;
        }

        .test-table .ok {
          color: green;
        }

        .test-table .fail {
          color: red;
        }

        .test-table .no-resource {
          color: gray;
        }

        .test-table td {
          padding: 3px;
        }

        table.links-to-pivots td {
          padding: 4px 6px;
          text-align: center;
        }

        .links-to-pivots table {
          display: inline-table;
          border-width: 2px 1px 1px 2px; /* right and bottom are 
                                            1px because TH also has 1px 
                                            at these sides and together
                                            they form 2px
                                         */

          border-style: solid;
          border-color: #0000EE;
          border-spacing: 0;
          color: #0000EE;
        }

        .links-to-pivots table td, .links-to-pivots table th{
          border: solid #0000EE;
          border-width: 0 1px 1px 0;
          padding: 2px 0.5ex;
          text-align: left;
          font-weight: bold;
        }

        .links-to-pivots a {
          text-decoration: none;
        }

        pre {
            margin-left: 4ex;
        }
        
    </style>

    <script type="text/javascript" id="js"> 

      /**
       * IE, unlike other browsers, doesn't support
       * tables (even with style "display: inline-table",
       * even in HTML5) inside the <A> tag. We fix this 
       * by providing javascript onclick handler for the 
       * tables; the handler delegates the click to the 
       * first found parent <A> element.
       */
      function ieTableAnchorFix(table) {
        if (navigator.userAgent.indexOf('MSIE') >= 0) {
          var parent = table.parentNode;
          while (parent && String(parent.nodeName).toUpperCase() != 'A') {
            parent = parent.parentNode;
          }
          if (parent) {
            parent.click();
          }
          return false;
        } else {
          return true;
        }
      }
    </script>

</head>
<body>

<h1><a href="http://github.com/cl-test-grid/cl-test-grid">CL Test Grid</a> Results Overview</h1>

<ul class="table-of-contents">
    <li><a href="#accessing-db">Accessing the Test Results Database</a></li>
    <li><a href="#failure-objects">FAILURE Objects</a></li>
    <li><a href="#pivot-tables">Displaying Data - Pivot Tables</a></li>
    <li><a href="#comparing-results">Comparing Resutlts to Find Regressions</a></li>
    <li><a href="#combining-failures-and-dependencies">Combining Failures and Dependency Information</a></li>
</ul>


<h3 id="accessing-db">Accessing the Test Results Database</h3>

<p>All the test grid results are stored in a plain s-expression
file. It is published in a separate git repository at
<a href="https://github.com/cl-test-grid/cl-test-grid-results"
   style="white-space: nowrap;">https://github.com/cl-test-grid/cl-test-grid-results</a>.</p>

<p>The <code>test-grid-reporting</code> package contains the
reporting code we will consider below.</p>

<p>Do the following:</p>

<code><pre>
$ git clone git@github.com:cl-test-grid/cl-test-grid.git
$ git clone git@github.com:cl-test-grid/cl-test-grid-results.git

CL-USER> (pushnew "cl-test-grid/" asdf:*central-registry* :test #'equal)
CL-USER> (ql:quickload :test-grid-reporting)
CL-USER> (in-package #:test-grid-reporting)
TEST-GRID-REPORTING> (defparameter *db* (test-grid-data:read-db))
</pre></code>

<h3 id="failure-objects">FAILURE Objects</h3>

<p>In most cases we found it convenient to convert
the database into a large list of <code>falure</code> objects:
<code><pre>
TEST-GRID-REPORTING> (defparameter *all-failures* (list-failures *db*))</pre></code></p>

<p>Having a list of <code>failures</code> it is easy to filter
and match them using standard Common Lisp functions.</p>

<p>The most interesting properties of the <code>falure</code> objects
are accessed using the following functions:
<pre><code>
(<b>fail-spec</b> failure)
=> Failure description in one of the following forms:

   <b>(:load "some-asdf-system-name" [:fail | :crash | :timeout])</b>

       Returned if the failure object represents failure of loading an ASDF system.

       Here the notation [:fail | :crash | :timeout] shoud be read as "one of :fail, :crash or :timeout".

       :fail means the load operation failed;

       :crash means the child lisp process loading asdf 
              system exited without returning a result;

       :timeout means that the child lisp process
              hasn't finished in a specified timeout time.

   <b>(:test-case "some-test-case-name" [:fail | :unexpected-ok])</b>

       Returned if the failure object represents failure of particular test case.

       :fail means the test case has failed;

       :unexpected-ok means that the testcase completed
                      successfully, but the library developers
                      have this testcase marked as a known failure
                      (known failures is a feature provided
                      by some test frameworks; it may be used
                      by the developers, for example, to mark
                      test cases which are impossible to fix right now,
                      maybe due to lack of support or bugs
                      in CL implemntatons, 3rd party libraries, or similar).

   <b>(:whole-test-suite [:no-resource | :fail | :crash | :timeout])</b>

       Result for a whole test suite.

       :fail Either some test cases failed but the test
             framework does not allow to distinguish
             particular test case, or some problem
             prevented the test suite from running at all.
             Example of such a problem may be that the
             testsuite or one of it's dependencies
             doesn't compile/load due to errors
             in lisp code; or absense of necessary
             foreign library on the test system.

       :no-resource This status is designed to represent
             situations when testsuite can not be run due
             to absense of necessary enviromnent.

             For example, CFFI test suite needs a small
             C library to be build. On Windows user must
             do it manually. If this library is not found,
             testgrid adapter of the CFFI test suite returns :no-resource.

             Or, external-program test suite can only be
             run on *nix platforms. On Windows testgrid
             adapter returns :no-resource.

             The :no-resource handling in testsuite adapters
             is optional, as every testsuite may have different
             requirements.

             Today, most testsuite adapters in testgrid
             do not implemente such a handling, and
             in case of any problems when running
             the tests :fail is recorded.

       :crash means the child lisp process running the test suite
              exited without returning a result;
        
       :timeout means that the child lisp process
              hasn't finished in a specified timeout time.

(<b>libname</b> failure)
=> Name of the library tested - a keyword, like :babel, :alexandria, etc.

(<b>lisp</b> failure)
=> Lisp implementation identifier - a string, for example "clisp-2.49-unix-x86_64",
   "cmu-20c_release-20c__20c_unicode_-linux-x86", "sbcl-1.0.54-linux-x64"

(<b>lib-world</b> failure)
=> A string naming the set of libraries and their versions used during testing,
   for example "quicklisp 2012-07-03", "quicklisp 2012-08-11".

(<b>system-name</b> failure)
=> If the failure descibes ASDF system load result, then the
   name of that ASDF system - a string, like "arnesi", "anaphora".
   Otherwize NIL.

(<b>log-uri</b> failure)
=> URI of the stored online output produced by the child lisp process
   performed the test suite or tested the ASDF system load.
</pre></code>
</p>

<p>For example, lets find all the alexandria failures on quickisp 2012-09-09:
<code><pre>
TEST-GRID-REPORTING> (remove-if-not (lambda (fail)
                                      (and (eq :alexandria (libname fail))
                                           (string= "quicklisp 2012-09-09" (lib-world fail))))
                                    *all-failures*)

=> (#&lt;"quicklisp 2012-09-09" "acl-8.2a-linux-x86" :ALEXANDRIA (:TEST-CASE "copy-hash-table.1" :FAIL) "http://cl-test-grid.appspot.com/blob?key=392081"&gt;
    #&lt;"quicklisp 2012-09-09" "acl-8.2a-linux-x86" :ALEXANDRIA (:TEST-CASE "type=.3" :FAIL) "http://cl-test-grid.appspot.com/blob?key=392081"&gt;
    #&lt;"quicklisp 2012-09-09" "acl-8.2a-linux-x86" :ALEXANDRIA (:TEST-CASE "type=.4" :FAIL) "http://cl-test-grid.appspot.com/blob?key=392081"&gt;
    ...)
</pre></code>

</p>
<p>
For better readability, package <code>test-grid-reporting</code>
defines the following function instead of <code>cl:remove-if-not</code>:
<code><pre>
(defun subset (superset predicate &key key)
  (remove-if-not predicate superset :key key))
</code></pre>
Example:
<code><pre>
TEST-GRID-REPORTING> (defparameter *some-failures*
                       (subset *all-failures*
                               (lambda (fail)
                                 (and (member (libname fail) '(:alexandria :let-plus))
                                      (member (lib-world fail)
                                              '("quicklisp 2012-09-09" "quicklisp 2012-08-11")
                                              :test #'string=)))))
</code></pre>
</p>

<h3 id="pivot-tables">Displaying Data - Pivot Tables</h3>

<p>
A convenient way to overview the results found is to
layout them into a table with sorted rows and columns
and thus grouping the results into groups and subgroups
according values of the properties selected for the rows and
columns.</p>

</>We have tools for that:

<code><pre>
TEST-GRID-REPORTING> (print-pivot "demo/some-failures.html"
                                  *some-failures*
                                  :rows '((lib-world string>) (lisp string<))
                                  :cols '((libname string<))
                                  :cell-printer (lambda (out cell-data)
                                                  (dolist (fail cell-data)
                                                    (format out
                                                            "&lt;a href=\"~a\"&gt;~a&lt;/a&gt;&lt;/br&gt;" 
                                                            (log-uri fail)
                                                            (fail-spec fail)))))
</code></pre>

Please review the resulting file: <a href="demo/some-failures.html">cl-test-grid/reports-generated/demo/some-failures.html</a>.
It is easy to see failures of each library grouped by quicklisp and lisp implementation.
Clicking the failure description refers to the log file, where the details may be found.
</p>

<h3 id="comparing-results">Comparing Resutlts to Find Regressions</h3>

<p>Lets say we want to compare new version of a compiler with an old version,
to ensure there is no regressions in the new version.</p>

<p>This is easy to do using the tools introduced above. The apporach:
<ol>
    <li>select two subsets of failures: of the old compiler and of the new one</li>
    <li>compute <code>exclusive-or</code> of these two subsets</li>
    <li>print the resut as a pivot where results of two compilers
        are represented side by side</li>
</ol></p>

<p>
The function <code>compiler-diff</code> implements this approach.
See its source code in <a href="https://github.com/cl-test-grid/cl-test-grid/blob/master/reporting/compiler-diff.lisp">cl-test-grid/reporting/compiler-diff.lisp</a>.
Note, it calls <code>fast-exclusive-or</code>. This function has exactly the
same prototype as <code>cl:set-exclusive-or</code>,
but takes advantage of hash tables if the <code>:test</code> parameter
is one of <code>cl:eq</code>, <code>cl:eql</code>, <code>cl:equal</code> or <code>cl:equalp</code>.
</p>

<p>Lets use <code>compiler-diff</code> to compare two versions of ABCL: old release 1.0.1
and some intermediate development version:
<code><pre>
TEST-GRID-REPORTING> (print-compiler-diff "demo/abcl-diff.html"
                                          *all-failures*
                                          "quicklisp 2012-09-09"
                                          "abcl-1.1.0-dev-svn-14157-fasl39-linux-java"
                                          "abcl-1.0.1-svn-13750-13751-fasl38-linux-java")
</code></pre>

The resulting report is stored in <a href="demo/abcl-diff.html">cl-test-grid/reports-generated/demo/abcl-diff.html</a>.
On the left column are the failures happened for the old release, but not happened for the new release
(i.e. improvements). On the right column the failures happened for the new version, but not
happened for the old release (regressions).</p>

<p>Lets compare two versions of Quicklisp.</p>

<p>The same approach: <code>exclusive-or</code> of two sets of failures: for old
Quicklisp version and for new one.</p>

<p>The source code: <a href="https://github.com/cl-test-grid/cl-test-grid/blob/master/reporting/quicklisp-diff.lisp">cl-test-grid/reporting/quicklisp-diff.lisp</a>.
As you can see, additional care is taken to ensure only failures
of CL implementations tested on both Quicklisp versions are
considered in the report</p>

<p>
<code><pre>
TEST-GRID-REPORTING> (print-quicklisp-diff-report "demo/quicklisp-diff.html"
                                                  *all-failures*
                                                  "quicklisp 2012-09-09"
                                                  "quicklisp 2012-08-11")
</code></pre>
The resulting report is stored in <a href="demo/quicklisp-diff.html">cl-test-grid/reports-generated/demo/quicklisp-diff.html</a>.
On the left column are the failures happened for the old quicklisp version, but not happened for the new version
(i.e. improvements). On the right column the failures happened for the new version, but not
happened for the old version (regressions).</p>

<h3> Move Pivot Reports Examples - Testsuite Results </h3>

<p>These pivot reports arrange results of all the testsuites
run on the last 3 Quicklisp versions into a tables similar to this:</p>

<table border="1" align="center" class="test-table">
  <tr>
    <td>&nbsp;</td><td>&nbsp;</td><td>sbcl-1-win</td><td>sbcl-1-linux</td><td>clisp-win</td>
  </tr>
  <tr>
    <td rowspan="3">quicklisp distro 1</td><td>flexi-stream</td><td class="ok">ok</td><td class="fail">fail</td><td class="ok">ok</td>
  </tr>
  <tr>
    <td>drakma</td><td class="fail">fail</td><td class="ok">ok</td><td class="no-resource">no-resource</td>
  </tr>
  <tr>
    <td>babel</td><td class="ok">ok</td><td class="ok">ok</td><td class="fail">fail</td>
  </tr>
  <tr>
    <td rowspan="3">quicklisp distro 2</td><td>flexi-stream</td><td class="ok">ok</td><td class="fail">fail</td><td class="ok">ok</td>
  </tr>
  <tr>
    <td>drakma</td><td class="fail">fail</td><td class="ok">ok</td><td class="no-resource">no-resource</td>
  </tr>
  <tr>
    <td>babel</td><td class="ok">ok</td><td class="ok">ok</td><td class="fail">fail</td>
  </tr>
  <tr>
    <td rowspan="3">quicklisp distro 3</td><td>flexi-stream</td><td class="ok">ok</td><td class="fail">fail</td><td class="ok">ok</td>
  </tr>
  <tr>
    <td>drakma</td><td class="fail">fail</td><td class="ok">ok</td><td class="no-resource">no-resource</td>
  </tr>
  <tr>
    <td>babel</td><td class="ok">ok</td><td class="ok">ok</td><td class="fail">fail</td>
  </tr>  
</table>

<p>Depending on what fields we choose for rows and columns, 
12 possible pivot variants are possible (the links are clickable):</p>

<table class="links-to-pivots" align="center">
  <tr>
    <td>
      <a href="pivot_lib_ql-lisp.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>lib</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lib_lisp-ql.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>lib</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_ql_lib-lisp.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>ql</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_ql_lisp-lib.html" >
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>ql</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lisp_lib-ql.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>lisp</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lisp_ql-lib.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>lisp</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
  </tr>
  <tr>
    <td>
      <a href="pivot_lib-ql_lisp.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>lib</td><td>ql</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lib-lisp_ql.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>lib</td><td>lisp</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_ql-lib_lisp.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>lisp</td></tr>
          <tr><td>ql</td><td>lib</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_ql-lisp_lib.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>ql</td><td>lisp</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lisp-lib_ql.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>ql</td></tr>
          <tr><td>lisp</td><td>lib</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
    <td>
      <a href="pivot_lisp-ql_lib.html">
        <table onclick="return ieTableAnchorFix(this)">
          <tr><td>&nbsp;</td><td>&nbsp;</td><td>lib</td></tr>
          <tr><td>lisp</td><td>ql</td><td>&nbsp;</td></tr>
        </table>
      </a>
    </td>
  </tr>
</table>

<p>We do not refer you to the source code of these reports,
as they are somewhat outdated - include only results of
testsuites, but not of ASDF systems load tests.</p>

<h3 id="combining-failures-and-dependencies">Combining Failures and Dependency Information</h3>

<p>When some ASDF system fails to load, it blocks all other
systems depending on it.</p>

<p>We can build a report showing which ASDF systems are
the most importatnt to fix.</p>

<p>The most fruitful systems to fix are those which:
<ul>
  <li>fail by themselves, i.e. don't have failing dependencies</li>
  <li>have many other systems depending on the given system</li>
  <li>in particular, these depending systems have the given system</li>
    as the only failed dependency (we say that the given system
    blocks them exclusively)</li>
</ul></p>

<p>For example, on particular version of ECL closer-mop fails to load,
and there are 123 other ASDF systems (related to 59 projects),
which depend on closer-mop and closer-mop is the only failing
dependency for them (in other words, closer-mop blocks them exclusively).</p>

<p>This means that fixing closer-mop is likely to fix 123 other ASDF
systems (unless these other systems have their own problems,
in this case we will at least reveal these problems).</p>

<p>Here is how to build such a report:
<code><pre>
TEST-GRID-REPORTING> (print-load-failures "demo/ecl-load-failures.html"
                                          *all-failures*
                                          "ecl-12.7.1-ce653d88-linux-x86-lisp-to-c"
                                          "quicklisp 2012-09-09")
</code></pre>

The report is stored at
<a href="demo/ecl-load-failures.html">cl-test-grid/reports-generated/demo/ecl-load-failures.html</a></p>

<p>In the default sorting is
<ul>
  <li>number of root-blocker-systems desc,</li>
  <li>number projects of systems blocked exclusively asc</li>
  <li>system name desc.</li>
</ul></p>

<p>I.e. the default sorting places the most fruitful systems at the top.</p>

<p>You may change sorting by clicking columns (holding Shift
to sort by multiple columns).</p>

<p>The reports for some CL implementations we have tested:
    <a href="abcl-load-failures.html">ABCL</a>
    <a href="acl-load-failures.html">ACL</a>
    <a href="ccl-load-failures.html">CCL</a>
    <a href="cmucl-load-failures.html">CMUCL</a>
    <a href="ecl-load-failures.html">ECL</a>
    <a href="sbcl-load-failures.html">SBCL</a>
</p>

<p>Note, there is no way (or at least non trivial) to extract the
dependency information 100% precise. ASDF systems are just lisp code,
sometimes they contain reader conditionals, sometimes
<code>asdf:load-op</code> invocations, instead of just putting the systems
into <code>:depends-on</code> or <code>:defsystem-depend-on</code>. But the information
we can gather is enough to make useful observations. We retrieve
the dependency information from <i>quicklisp/dists/quicklisp/systems.txt</i>
index file.</p>

</body>
</html>
